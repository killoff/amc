<?php /** @var $this \Amc\Timetable\Block\Adminhtml\Order\Tab\Timetable */ ?>
<?php $resourcesAndEvents = $this->getResourcesAndEvents() ?>
<script>
    require([
        "moment",
        "jquery",
        "jquery/jquery-ui",
        "fullcalendar-scheduler-1.0.2/lib/fullcalendar.min",
        "fullcalendar-scheduler-1.0.2/scheduler"
    ], function(moment, $){

        $(function() { // document ready


            var uuid = function () {
                var i, random;
                var uuid = '';

                for (i = 0; i < 32; i++) {
                    random = Math.random() * 16 | 0;
                    if (i === 8 || i === 12 || i === 16 || i === 20) {
                        uuid += '-';
                    }
                    uuid += (i === 12 ? 4 : (i === 16 ? (random & 3 | 8) : random))
                        .toString(16);
                }

                return uuid;
            };

            var $timetable = $('#order-timetable');
            var registry = {};
//            var legend = [];
//            var resources = <?php //echo $resourcesAndEvents['resources'] ?>//;
//            for (var i =0; i < resources.length; i++) {
//
//            }

            $timetable.fullCalendar({
                editable: true,
                contentHeight: 'auto',
                scrollTime: '00:00',
                header: {
                    left: 'today prev,next',
                    center: 'title',
                    right: 'timelineDay,timelineThreeDays'
                },
                defaultView: 'timelineDay',
                views: {
                    timelineThreeDays: {
                        type: 'timeline',
                        duration: { days: 3 }
                    }
                },
                businessHours: {
                    start: '9:00',
                    end: '20:00',
                    dow: [ 1, 2, 3, 4, 5 ]
                },
                minTime: '09:00', // todo: impldement config "Working hours"
                maxTime: '20:00', // todo: impldement config "Working hours"
                slotLabelFormat: 'HH:mm',
                eventOverlap: true, // will cause the event to take up entire resource height
                resourceAreaWidth: '25%',
                resourceLabelText: "<?php echo $this->escapeQuote(__('Executant')) ?>",
                selectable: true,
                selectHelper: true,
                slotDuration: '00:15',
                slotWidth: 15,
                eventResize: function(event, delta, revertFunc) {
                    registry[event.id] = event;


                    var resource = $timetable.fullCalendar( 'getResourceById', event.resourceId );
//                    console.log(event);
//                    console.log(resource);
//                    id: "i2_u4"
//                    parent: Object
//                    title: "Узистов В."
//                    type: "user"
                    console.log(registry);

                },
                eventDrop: function(event, delta, revertFunc) {
                    registry[event.id] = event;

//                    alert(event.title + " was dropped on " + event.start.format()+ " - "+event.end.format());
//                    console.log(event);

//                    if (!confirm("Are you sure about this change?")) {
//                        revertFunc();
//                    }
                    console.log(registry);

                },
                select: function(start, end, event, calendar, resource) {
                    var eventData;
                    var resourceId = resource.id;
                    var resourceType = resource.type;
                    if (resourceId && resourceType === 'user') {
                        eventData = {
                            title: '', // time start - time end?
                            start: start,
                            end: end,
                            resourceId: resourceId,
                            id: uuid(),
                        };
                        $timetable.fullCalendar('renderEvent', eventData, true); // stick? = true
                        registry[eventData.id] = eventData;
//                        console.log(eventData);
                        console.log(registry);
                        console.log($timetable.fullCalendar( 'getResourceEvents', resourceId ));

                    }
                    $timetable.fullCalendar('unselect');
//                    console.log(event);
                },
                selectOverlap: function(event) {
                    console.log(event);
                    return event.rendering === 'background';
                },


                resources: <?php echo $resourcesAndEvents['resources'] ?>,
                events:  <?php echo $resourcesAndEvents['events'] ?>

//                    [
//                    {
//                        resourceId: 'c1',
//                        id: 'availableForMeeting',
//                        start: '2015-12-07T09:30:00',
//                        end: '2015-12-07T16:30:00',
//                        rendering: 'background',
//                        overlap: true,
//                        title: 'event 5'
//                    },
//                    {
//                        resourceId: 'c1',
//                        id: 'availableForMeetingNoe',
//                        start: '2015-12-07T11:30:00',
//                        end: '2015-12-07T13:30:00',
//                        rendering: 'background',
//                        color: '#ff9f89',
//                        overlap: false,
//                        selectable: false
//
//                    },
//
//                    {
//                        resourceId: 'a1',
//                        id: 'availableForMeeting',
//                        start: '2015-12-07T10:30:00',
//                        end: '2015-12-07T15:30:00',
//                        rendering: 'background',
//                        overlap: true,
//                        title: 'event 5'
//                    },
//                    {
//                        resourceId: 'a1',
//                        id: 'availableForMeetingNoe',
//                        start: '2015-12-07T10:30:00',
//                        end: '2015-12-07T12:00:00',
//                        rendering: 'background',
//                        color: '#ff9f89',
//                        overlap: false,
//                        selectable: false
//
//                    },
//                    {
//                        resourceId: 'a2',
//                        id: 'availableForMeeting',
//                        start: '2015-12-07T11:30:00',
//                        end: '2015-12-07T17:30:00',
//                        rendering: 'background',
//                        overlap: true,
//                        title: 'event 5'
//                    },
//                    {
//                        resourceId: 'a2',
//                        id: 'availableForMeetingNoe',
//                        start: '2015-12-07T14:30:00',
//                        end: '2015-12-07T16:30:00',
//                        rendering: 'background',
//                        color: '#ff9f89',
//                        overlap: false,
//                        selectable: false
//
//                    }
//
//                ]
            });

        });
    });
</script>
